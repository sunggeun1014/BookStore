<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="CustomerOrders">

	<select id="getList" resultType="customerOrders" parameterType="condition">
		SELECT * FROM (SELECT
		    co.order_num,
		    co.member_id,
		    m.member_name,
		    CASE
		    WHEN co.order_delivery_status = '01' THEN
		    '배송전'
		    WHEN co.order_delivery_status = '02' THEN
		    '배송중'
		    WHEN co.order_delivery_status = '03' THEN
		    '배송완료'
		    END                         AS order_delivery_status,
		    CASE
		    WHEN co.order_payment_status = '01' THEN
		    '결제완료'
		    WHEN co.order_payment_status = '02' THEN
		    '환불완료'
		    END                         AS order_payment_status,
		    CASE
		    WHEN EXISTS (
		        SELECT
		            1
		        FROM
		            customer_order_details internal_cod
		        WHERE
		            internal_cod.order_num = co.order_num
		            AND internal_cod.order_detail_status IN ( '02', '03', '04' )
		    ) THEN
		    '변경요청'
		    WHEN EXISTS (
		        SELECT
		            1
		        FROM
		            customer_order_details internal_cod
		        WHERE
		            internal_cod.order_num = co.order_num
		            AND internal_cod.order_detail_status IN ( '05', '06', '07', '08' )
		    ) THEN
		    '처리완료'
		    ELSE
		    '주문완료'
		    END                         AS order_status,
		    co.order_purchase_date,
		    co.order_modify_date,
		    SUM(cod.order_detail_price) AS total_order_price
		FROM
		    customer_orders        co
		    LEFT JOIN members                m ON co.member_id = m.member_id
		    LEFT JOIN customer_order_details cod ON cod.order_num = co.order_num
		GROUP BY
		    co.order_num,
		    co.member_id,
		    m.member_name,
		    co.order_delivery_status,
		    co.order_payment_status,
		    co.order_purchase_date,
		    co.order_modify_date) rs 
		WHERE 1 = 1
		    <if test="date_column != null and !date_column.equals('') and date_column.equals('purchase')">
				<if test="start_date != null and !start_date.equals('')">
					AND to_char(order_purchase_date, 'YYYY-MM-DD') >= #{start_date}
				</if>
				<if test="end_date != null and !end_date.equals('')">
					AND to_char(order_purchase_date, 'YYYY-MM-DD') <![CDATA[<=]]> #{end_date}
				</if>
			</if>
			<if test="date_column != null and !date_column.equals('') and date_column.equals('reuqest')">
				<if test="start_date != null and !start_date.equals('')">
					AND to_char(order_modify_date, 'YYYY-MM-DD') >= #{start_date} AND order_purchase_date != order_modify_date 
				</if>
				<if test="end_date != null and !end_date.equals('')">
					AND to_char(order_modify_date, 'YYYY-MM-DD') <![CDATA[<=]]> #{end_date} AND order_purchase_date != order_modify_date
				</if>
			</if>
			<if test="order_status != null and !order_status.equals('')">
				<if test="order_status.equals('request')">
					AND order_status = '변경요청' 
				</if>
				<if test="order_status.equals('completion')">
					AND order_status = '처리완료' 
				</if>
			</if>
			<if test="search_conditions != null and !search_conditions.equals('')">
				<if test="word != null and !word.equals('')">
					AND order_num = #{word}
				</if>
			</if>
	</select>
	
	<insert id="deliveryRequestSave" parameterType="String">
		INSERT
		    INTO delivery_request (
		        request_num,
		        manager_id
		    ) VALUES(
		    	delivery_request_seq.nextval,
		    	#{manager_id}
		    )
	</insert>
	
	<insert id="deliveryDetailSave" parameterType="Integer">
		INSERT
		    INTO delivery_request_detail (
		        request_detail_num,
		        request_num,
		        order_num
		    ) VALUES(
		    	delivery_request_detail_seq.nextval,
		    	delivery_request_seq.currval,
		    	#{order_num}
		    )
	</insert>
	
	
</mapper>